# 09-12

### 트랜잭션

- DB에서 하나의 작업으로 처리되는 논리적 작업 단위
- 여러 SQL 작업을 하나로 묶어, 모두 성공하면 적용하고, 하나라도 실패하면 취소 할 수 있음.

```sql
- - 1. AutoCommit 해제
SET AUTOCOMMIT = 0;

-- 2. 커밋 또는 롤백
COMMIT;     -- 변경사항 확정
ROLLBACK;   -- 변경사항 취소
```

1. 기본값은 AUTOCOMMIT = 1
    - SQL을 실행하면 즉시 DB에 적용됨
2. AUTOCOMMIT = 0
    - 수동으로 COMMIT 해야 변경 사항이 반영됨
    - COMMIT 전에 시스템이 종료되면 변경 내용은 모두 사라짐
3. 터미널과 Workbench에서 별도 세션에서  AUTOCOMMIT 값을 0으로 설정하면, 한 세션에서 COMMIT해도 다른 세션에는 반영되지 않음
    
     즉, 각각의 세션에서 별도로 COMMIT 해줘야 한다. (둘 다 COMMIT 해줘야 함.)
    

### ALTER TABLE

- 테이블의 구조(스키마) 변경 명령어
- **컬럼 추가, 수정/삭제**, 제약조건, 인덱스, 기본값 변경 등도 가능

```java
alter table A
add column updated_date timestamp null;
```

- A 테이블에  updated_date timestamp 컬럼을 추가하고 값은 null로 채운다.

### 인덱스

- 데이터 검색 속도를 향상시키기 위한 자료구조
- 인덱스를 적절히 적용하여 데이터 조회 성능을 크게 향상시킬 수 있음.
    - 조회 속도가 느린 회원 테이블의  <이름 컬럼>과 <가입일 컬럼> 인덱스를 적용하여, 검색 쿼리 실행 시간은 0.5초 → 0.05초로 단축하였다.

```sql
-- 인덱스 생성
CREATE INDEX employees_hire_date_idx -- <- 적절한 아무 이름을 적어주면 됨
ON employees(hire_date); 
```

- employees 테이블의 hire_date 컬럼에 인덱스를 만든다.

---

### JDBC

**JDBC(Java Database Connectivity)**는 Java 애플리케이션에서 데이터베이스에 접속하고 SQL을 실행하기 위한 표준 API입니다.

### JDBC 구성 요소

| 구성 요소  | 설명 |
| --- | --- |
| DriverManager | JDBC 드랑비 관리, Connection 생성 |
| Connection | 데이터베이스 연결 |
| Statement | SQL 문장 실행 |
| PreparedStatement | 미리 컴파일된 SQL 실행 |
| CallableStatement | 저장 프로시저 실행 |
| ResultSet | SELECT 결과 저장 |

### MySQL JDBC 드라이버 설정 및 기타 설정

**Gradle 의존성 추가**

```java
// build.gradle 파일에 추가 (추가 후 코끼리 버튼 클릭)
dependencies {
    implementation 'mysql:mysql-connector-java:8.0.31'
}
```

1. File → Project Structure → Librares → + 버튼, From Maven… → implementation('com.mysql:mysql-connector-j:8.3.0') → OK
2. File → Settings → Bulid, Execution, Deployment → Gradle → Build and run using / Run tests using : IntelliJ IDEA로 변경

### 데이터베이스 연결

```java
jdbc:mysql://[host]:[port]/[database]?[parameters]

// DBMS들 마다 원하는 url 형식이 조금씩 다르다.
// -> String url = "jdbc:mysql://localhost:3306/liondb"; 

package lion;
import java.sql.Connection;
import java.sql.DriverManager;

public class ConnectionTest {
    public static void main(String[] args) throws Exception {
        // 자바프로그램도 DBMS 입장에서 클라이언트이다.
        // 1. DB 접속해야함  Connection -- 접속이 추상화된 객체.

        // Class.forName("com.mysql.cj.jdbc.Driver");

        Connection connection = null;
        String url = "jdbc:mysql://localhost:3306/liondb";    // DBMS들 마다 원하는 url 형식이 조금씩 다르다.
        String user = "root";
        String password = "root1234";
        connection = DriverManager.getConnection(url, user, password);

        if (connection != null) {
            System.out.println("성공입니다!~!~!~~");
        }
        else {
            System.out.println("실패~!~!~!~~!");
        }
        
        connection.close();
    }
}
```

- Connection 생성
- Connection URL 파라미터
- try-with-resources 사용 → 실습에서는 간단하게 throws 사용

### INSERT 작업

```java
package lion;

import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.PreparedStatement;
import java.sql.SQLException;

public class InsertTest {
    public static void main(String[] args) throws Exception {
        // 0. 드라이버로딩. (MySQL 드라이버를 메모리에 올려준다)

        String url = "jdbc:mysql://localhost:3306/liondb";    // DBMS들 마다 원하는 url 형식이 조금씩 다르다.
        String user = "root";
        String password = "root1234";

        // 1. 접속 -- Connection
        Connection conn = DriverManager.getConnection(url, user, password);

        // 2. 쿼리작성 -- Statement, PreparedStatement
        // 쿼리문이 실행 될때 DBMS가 알아들을 수 있게 번역(파싱)된다.
        // insert into students(name) values('kang');
        // insert into students(name) values('hong');
        // 위의 쿼리는 각자 다른 쿼리로 인식!! statement는 값까지 들어간 완벽한 쿼리로 실행 된다.
        // insert into student(name) values(?); -- 여기까지를 번역함
        String sql = "insert into dept(deptno, dname, loc) values(?,?,?)";
        PreparedStatement ps = conn.prepareStatement(sql);

        // 반드시 ? 에 값을 채워줘야한다. -- 쿼리를 완성 시켜줘야함.
        ps.setInt(1, 50); // 1번에 1값 "deptno", 1 로 써줘도 됨
        ps.setString(2, "lion");
        ps.setString(3, "seoul");

        // 3.실행
        int resultCount = ps.executeUpdate();

        if(resultCount == 1) {
            System.out.println("입력성공!");
        }

        ps.close();
        conn.close();
    }
}

```

- **간단히 테스트** → `Statement`
- **실무/프로젝트/보안 중요** → `PreparedStatement` (거의 표준처럼 씀) 프리페어드
    - 값 부분을 ? 표로 채워서 사용한다.
- DB테이블을 확인해 보면 liondb에 값이 잘 들어가 있다.