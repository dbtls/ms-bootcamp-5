# JDBC 프로그래밍 절차

## 기본 프로그래밍 순서

<img width="718" height="722" alt="Image" src="https://github.com/user-attachments/assets/0fea8144-68ed-4ae8-95ba-861483da6e87" />

1. **import** java.sql 패키지
2. **Connection** 객체 생성 (DriverManager 이용)
3. **PreparedStatement** 객체 생성
4. **파라미터 바인딩** (? 값 설정)
5. **SQL 실행**
    - SELECT: executeQuery() → ResultSet
    - INSERT / UPDATE / DELETE: executeUpdate() → int
6. **리소스 해제** (close)

## 기본 코드 구조

```java
import java.sql.*;

public class JdbcExample {
	public static void main(String[] args) {
		// JDBC 4(최신)에서는 없이도 동작하지만, 레거시 환경이면 추가
		// Class.forName("com.mysql.cj.jdbc.Driver");
		
		// JDBC 변수 선언
		Connection conn = null;
		PreparedStatement ps = null;
		ResultSet rs = null;
		
		try {
			// 1. Connection 생성
			String url = "jdbc:mysql://localhost:3306/examplesdb";
			conn = DriverManager.getConnection(url, "urstory", "u1234");
			
			// 2. PreparedStatement 생성
			String sql = "SELECT * FROM user WHERE email = ?";
			ps = conn.prepareStatement(sql);
			
			// 3. 파라미터 바인딩
			ps.setString(1, "test@example.com");
			
			// 4. SQL 실행
			rs = ps.executeQuery();
			
			// 5. 결과 처리
			while (rs.next()) {
				// 데이터 읽기
			}
			
		} catch (SQLException e) {
			e.printStackTrace();
			
		} finally {
			// 6. 리소스 해제
			if (rs != null) try {rs.close();} catch (SQLException e) {}
			if (ps != null) try {ps.close();} catch (SQLException e) {}
			if (conn != null) try {conn.close();} catch (SQLException e) {}
		}
	}
}
```

# 데이터베이스 연결

## Connection 연결

```java
// 기본 연결
String url = "jdbc:mysql://localhost:3306/examplesdb";
String user = "urstory";
String password = "u1234";

Connection conn = DriverManager.getConnection(url, user, password);
```

## Connection URL 파라미터

```java
// 파라미터를 포함한 연결
String url = "jdbc:mysql://localhost:3306/examplesdb" +
							"?useSSL=false" +
							"&serverTimezone=Asia/Seoul" +
							"&characterEncoding=UTF-8";

Connection conn = DriverManager.getConnection(url, user, password);
```

## try-with-resources 사용

```java
// Java 7+ 자동 리소스 관리
String url = "jdbc:mysql://localhost:3306/examplesdb";

try (Connection conn = DriverManager.getConnection(url, "urstory", "u1234")) {
	// 데이터베이스 작업
	System.out.println("Connected to database!");
} catch (SQLException e) {
	e.printStackTrace();
}

// Connection 자동으로 close
```

# INSERT 작업

## 기본 INSERT

```java
public void insertUser(String email, String name, String password) {
	String sql = "INSERT INTO user (email, name, password, regdate) " +
								"VALUES (?, ?, ?, NOW())";
	
	try (Connection conn = getConnection();
			PreparedStatement ps = conn.prepareStatement(sql)) {
			
			// 파라미터 바인딩
			ps.setString(1, email);
			ps.setString(2, name);
			ps.setString(3, password);
			
			// SQL 실행
			int updateCount = ps.executeUpdate();
			System.out.println(updateCount + "개의 행이 입력되었습니다.");
		
	} catch (SQLException e) {
		e.printStackTrace();
	}
}
```

## 자동 생성된 키 가져오기

```java
public Long insertAndGetId(String email, String name, String password) {
	String sql = "INSERT INTO user (email, name, password) VALUES (?, ?, ?)";
	Long generatedId = null;
	
	try (Connection conn = getConnection();
			PreparedStatement ps = conn.prepareStatement(sql,
						Statement.RETURN_GENERATED_KEYS)) {
		
		ps.setString(1, email);
		ps.setString(2, name);
		ps.setString(3, password);
		
		int updateCount = ps.executeUpdate();
		
		// 생성된 키 가져오기
		if (updateCount > 0) {
			try (ResultSet rs = ps.getGeneratedKeys()) { // AUTO_INCREMENT PK가 있어야 값 반환
				if (rs.next()) {
					generatedId = rs.getLong(1);
				}
			}
		}
	} catch (SQLException e) {
		e.printStackTrace();
	}
	
	return generatedId;
}
```

# SELECT 작업

## 단일 행 조회

```java
public User getUserByEmail(String email) {
	String sql = "SELECT user_id, email, name, password, regdate " +
								"FROM user WHERE email = ?";
	User user = null;
	
	try (Connection conn = getConnection();
			PreparedStatement ps = conn.prepareStatement(sql)) {
		
		ps.setString(1, email);
		
		try (ResultSet rs = ps.executeQuery()) {
			if (rs.next()) {
				user = new User();
				user.setUserId(rs.getLong("user_id"));
				user.setEmail(rs.getString("email"));
				user.setName(rs.getString("name"));
				user.setPassword(rs.getString("password"));
				user.setRegdate(rs.getTimestamp("regdate"));
			}
		}
	} catch (SQLException e) {
		e.printStackTrace();
	}
	
	return user;
}
```

## 다중 행 조회

```java
public List<User> getAllUsers() {
	String sql = "SELECT user_id, email, name, regdate FROM user";
	List<User> users = new ArrayList<>();
	
	try (Connection conn = getConnection();
			PreparedStatement ps = conn.prepareStatement(sql);
			ResultSet rs = ps.executeQuery()) {
		
		while (rs.next()) {
			User user = new User();
			user.setUserId(rs.getLong("user_id"));
			user.setEmail(rs.getString("email"));
			user.setName(rs.getString("name"));
			user.setRegdate(rs.getTimestamp("regdate"));
			users.add(user);
		}
	} catch (SQLException e) {
		e.printStackTrace();
	}
	
	return users;
}
```

## 페이징 처리

```java
public List<Board> getBoardList(int page, int size) {
	String sql = "SELECT board_id, title, user_id, regdate, view_cnt " +
								"FROM board " +
								"ORDER BY board_id DESC " +
								"LIMIT ?, ?";
	
	List<Board> boards = new ArrayList<>();
	int offset = (page - 1) * size;
	
	try (Connection conn = getConnection();
			PreparedStatement ps = conn.prepareStatement(sql)) {
		
		ps.setInt(1, offset);
		ps.setInt(2, size);
		
		try (ResultSet rs = ps.executeQuery()) {
			while (rs.next()) {
				Board board = new Board();
				board.setBoardId(rs.getLong("board_id"));
				board.setTitle(rs.getString("title"));
				board.setUserId(rs.getLong("user_id"));
				board.setRegdate(rs.getTimestamp("regdate"));
				board.setViewCnt(rs.getInt("view_cnt"));
				boards.add(board);
			}
		}
	} catch (SQLException e) {
		e.printStackTrace();
	}
	
	return boards;
}
```

# UPDATE 와 DELETE

## UPDATE 작업

```java
public boolean updateUser(Long userId, String name, String password) {
	String sql = "UPDATE user SET name = ?, password = ? WHERE user_id = ?";
	
	try (Connection conn = getConnection();
			PreparedStatement ps = conn.prepareStatement(sql)) {
		
		ps.setString(1, name);
		ps.setString(2, password);
		ps.setLong(3, userId);
		
		int updateCount = ps.executeUpdate();
		return updateCount > 0;
	
	} catch (SQLException e) {
		e.printStackTrace();
		return false;
	}
}
```

## DELETE 작업

```java
public boolean deleteUser(Long userId) {
	String sql = "DELETE FROM user WHERE user_id = ?";
	
	try (Connection conn = getConnection();
			PreparedStatement ps = conn.prepareStatement(sql)) {
		
		ps.setLong(1, userId);
		
		int updateCount = ps.executeUpdate();
		return updateCount > 0;
	
	} catch (SQLException e) {
		e.printStackTrace();
		return false;
	}
}
```

## ExecuteQuery vs ExecuteUpdate

- **executeQuery()**
    - **SELECT 문**을 실행할 때 사용하며, 결과가 `ResultSet`으로 반환된다.
- **executeUpdate()**
    - **INSERT**, **UPDATE**, **DELETE** 문과 같이 데이터를 변경하는 SQL 실행 시 사용한다.
    - `int`값을 반환하는데, 이것은 몇 개의 행이 변경되었는지를 의미한다.

# PreparedStatement vs Statement

## SQL Injection 방지

```java
// 위험한 코드 (Statement 사용) - SQL Injection 가능
public User getUserUnsafe(String email) {
	String sql = "SELECT * FROM user WHERE email = '" + email + "'";
	// email = "test' OR '1' = '1" 입력 시 모든 사용자 조회
	
	try (Connection conn = getConnection();
			Statement stmt = conn.createStatement();
			ResultSet rs = stmt.executeQuery(sql)) {
		
		// ...
	}
}

// 안전한 코드 (PreparedStatement 사용)
public User getUserSafe(String email) {
	String url = "SELECT * FROM user WHERE email = ?";
	
	try (Connection conn = getConnection();
			PreparedStatement ps = conn.prepareStatement(sql)) {
		
		ps.setString(1, email); // 자동으로 이스케이프 처리
		// ...
	}
}
```

## PreparedStatement 장점

| **특징** | **설명** |
| --- | --- |
| SQL Injection 방지 | 파라미터 자동 이스케이프 |
| 성능 향상 | SQL 사전 컴파일로 재사용 시 빠르다. |
| 가독성 | 파라미터 바인딩으로 코드가 명확하다. |
| 타입 안정성 | 메서드별 타입을 체크한다. |

# DAO 패턴

## User DTO

```java
public class User {
	private Long userId;
	private String email;
	private String name;
	private String password;
	private Timestamp regdate;
	
	// Getter, Setter
	// ...
}
```

## User DAO

```java
public class UserDAO {
	private static final String URL = "jdbc:mysql://localhost:3306/examplesdb";
	private static final String USER = "urstory";
	private static final String PASSWORD = "u1234";
	
	private Connection getConnection() throws SQLException {
		return DriverManager.getConnection(URL, USER, PASSWORD);
	}
	
	// 사용자 등록
	public boolean registerUser(User user) {
		// ...
	}
	
	// 로그인 확인
	public User login(String email, String password) {
		// ...
	}
	
	// 리소스 정리 헬퍼 메서드
	private void closeResources(Connection conn, PreparedStatement ps, ResultSet rs) {
		if (rs != null) try { rs.close(); } catch (SQLException e) {}
		if (ps != null) try { ps.close(); } catch (SQLException e) {}
		if (conn != null) try { conn.close(); } catch (SQLException e) {}
	}
}
```

## DTO vs DAO

- **DTO**
    - 데이터를 담는 그릇 역할을 하는 클래스이다.
    - 계층 간(Controller ↔ Service ↔ DAO 등)의 데이터 전달을 목적으로만 사용한다.
    - 로직이 없어야 하며, 오직 필드와 Getter/Setter만 포함하는 순수 데이터 객체이다.
    - 계층 간 의존을 최소화하고, 불필요한 노출을 방지한다.
- **DAO**
    - 데이터베이스에 접근하는 책임을 가진 객체이다.
    - DB 연결, SQL 실행, 결과 매핑 등의 직접적인 DB 작업을 수행한다.
    - DB의 테이블 구조에 맞춘 CRUD 작업을 수행한다.
    - 보통 Service 계층에서 DAO를 호출하여 비즈니스 로직과 분리한다.

## 수업 진행 예제

### Util

```java
public class DBUtil {
	
	public static Connection getConnection() throws SQLException {
		String url = "jdbc:mysql://localhost:3307/liondb";
		String user = "root";
		String password = "root1234";
		
		return DriverManager.getConnection(url, user, password);
	}
	
	public static void close(ResultSet rs) {
		if (rs != null) {
			try {
				rs. close();
			} catch (SQLException e) {
				throw new RuntimeException(e);
			}
		}
	}
}
```

### DTO

```java
public class DeptDTO {
	
	private int deptno;
	private String dname;
	private String loc;
	
	public int getDeptno() {
		return deptno;
	}
	
	public void setDeptno(int deptno) {
		this.deptno = deptno;
	}
	
	public String getDname() {
		return dname;
	}
	
	public void setDname(String dname) {
		this.dname = dname;
	}
	
	public String getLoc() {
		return loc;
	}
	
	public void setLoc(String loc) {
		this.loc = loc;
	}
	
	@Override
	public String toString() {
		return "DeptDTO{" +
						"deptno=" + deptno +
						", dname='" + dname + '\'' +
						", loc='" + loc + '\'' +
						'}';
	}
}
```

### DAO

```java
public class DeptDAO {
	
	// 삽입
	public boolean insertDept(DeptDTO deptDTO) {
		String sql = "INSERT INTO dept (deptno, dname, loc) VALUES (?, ?, ?)";
		boolean resultFlag = false;
		
		try ( // 1. 접속
				Connection conn = DBUtil.getConnection();
				PreparedStatement ps = conn.prepareStatement(sql)
				// 쿼리 작성 -- Statement -- > PreparedStatement
		) {
			
			ps.setInt(1, deptDTO.getDeptno());
			ps.setString(2, deptDTO.getDname());
			ps.setString(3, deptDTO.getLoc());
			
			// 실행
			int resultCount = ps.executeUpdate();
			
			// 결과 확인
			// System.out.println(resultCount);
			
			if (resultCount == 1) {
				resultFlag = true;
				System.out.println("입력 성공!");
			}
		} catch (SQLException e) {
			throw new RuntimeException("INSERT 오류 발생!", e);
		}
		
		return resultFlag;
	}
	
	// 수정
	public int updateDname(String dname, int deptno) {
		String sql = "UPDATE dept SET dname = ? WHERE deptno = ?";
		int resultCount = 0;
		
		try (Connection conn = DBUtil.getConnection();
				PreparedStatement ps = conn.prepareStatement(sql)) {
			
			ps.setString(1, dname);
			ps.setInt(2, deptno);
			
			resultCount = ps.executeUpdate();
		} catch (SQLException e) {
			throw new RuntimeException("UPDATE 오류 발생!", e);
		}
		
		return resultCount;
	}
	
	// 삭제
	public int deleteDept(int deptno) {
		String sql = "DELETE FROM dept WHERE deptno = ?";
		int resultCount = 0;
		
		try (Connection conn = DBUtil.getConnection();
				PreparedStatement ps = conn.prepareStatement(sql)) {
			
			ps.setInt(1, deptno);
			resultCount = ps.executeUpdate();
		} catch (SQLException e) {
			throw new RuntimeException("DELETE 오류 발생!", e);
		}
		
		return resultCount;
	}
	
	// 조회
	public List<DeptDTO> getDeptList() {
		List<DeptDTO> deptList = new ArrayList<>();
		
		String sql = "SELECT deptno, dname, loc FROM dept";
		
		try (Connection conn = DBUtil.getConnection();
				PreparedStatement ps = conn.prepareStatement(sql);
				ResultSet rs = ps.executeQuery()) {
			
			while (rs.next()) {
				DeptDTO deptDTO = new DeptDTO();
				deptDTO.setDeptno(rs.getInt(1));
				deptDTO.setDname(rs.getString(2));
				deptDTO.setLoc(rs.getString(3));
				
				deptList.add(deptDTO);
			}
		} catch (SQLException e) {
			throw new RuntimeException("SELECT 오류 발생!", e);
		}
		
		return deptList;
	}
	
	// 한 건만 조회
	public DeptDTO getDept(int deptno) {
		String sql = "SELECT deptno, dname, loc FROM dept WHERE deptno=?";
		DeptDTO deptDTO = null;
		ResultSet rs = null;
		
		try (Connection conn = DBUtil.getConnection();
				PreparedStatement ps = conn.prepareStatement(sql)) {
			
			ps.setInt(1, deptno);
			rs = ps.executeQuery();
			
			if (rs.next()) {
				deptDTO = new DeptDTO(); // 해당 데이터가 존재할 때만 생성
				deptDTO.setDeptno(rs.getInt(1)); // 인덱스 활용 가능 (유지보수 취약)
				deptDTO.setDname(rs.getString("dname")); // 컬럼명 활용 가능 (유지보수 용이)
				deptDTO.setLoc(rs.getString("loc"));
			}
		} catch (Exception e) {
			throw new RuntimeException("한 건 조회 오류 발생!", e);
		} finally {
			DBUtil.close(rs);
		}
		
		return deptDTO;
	}
}
}
```
